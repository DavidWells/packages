service: worker-service

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  stage: ${opt:stage, 'dev'}
  region: us-east-1
  memorySize: 512
  timeout: 60
  environment:
    STAGE: ${self:provider.stage}
    QUEUE_URL: ${self:custom.queueUrl}

custom:
  queueUrl:
    Ref: JobQueue

functions:
  processJob:
    handler: handlers/jobs.process
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - JobQueue
              - Arn
          batchSize: 10

  scheduleJob:
    handler: handlers/jobs.schedule
    events:
      - schedule:
          rate: rate(5 minutes)
          enabled: true

  sendNotification:
    handler: handlers/notifications.send
    events:
      - sns:
          arn:
            Ref: NotificationTopic
          topicName: ${self:service}-${self:provider.stage}-notifications

  cleanupOldRecords:
    handler: handlers/cleanup.run
    events:
      - schedule:
          rate: cron(0 2 * * ? *)
          enabled: true

resources:
  Resources:
    JobQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-jobs
        VisibilityTimeout: 120

    NotificationTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:service}-${self:provider.stage}-notifications
